# THIS MUST BE OUTSIDE THE SERVER BLOCK
map $cookie_user_banned $is_banned {
    "true"  1;
    default 0;
}

server {
    listen 80;
    root /var/www/html;

    # Allow access to ban pages without authentication
    location = /student/ban.html {
        auth_basic off;
        allow all;
    }
    location = /student/index.html {
        auth_basic off;
        allow all;
    }

    location / {
        # Redirect banned users
        if ($is_banned) {
            return 302 /student/ban.html;
        }

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        index index.html index.htm;
        try_files $uri $uri/ =404;
        
        autoindex on;
        autoindex_format json;
        add_header Content-Type text/html;
        add_before_body /header.html;
    }

    # Action URLs
    location /8675unbanme309 {
        add_header Set-Cookie "user_banned=false; Path=/; Max-Age=0; HttpOnly";
        return 302 /; 
    }

    location /8675banme309 {
        add_header Set-Cookie "user_banned=true; Path=/; Max-Age=31536000; HttpOnly";
        return 302 /student/ban.html;
    }
	location ~ ^/Scripts/website/requests/texts/(?<chatname>.+)\.json$ {
    # 1. Require general htpasswd login first
    auth_basic "Restricted Chat";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # 2. Perform the stealth access check
    access_by_lua_block {
        local cjson = require "cjson"
        local file_path = ngx.var.document_root .. ngx.var.uri
        
        -- Try to open the file
        local f = io.open(file_path, "rb")
        if not f then 
            ngx.exit(ngx.HTTP_NOT_FOUND) 
        end
        
        local content = f:read("*all")
        f:close()

        -- Parse JSON and check membership
        local data = cjson.decode(content)
        local current_user = ngx.var.remote_user
        local is_authorized = false

        for _, user in ipairs(data.users) do
            if user == current_user then
                is_authorized = true
                break
            end
        end

        -- HIDDEN: Return 404 if not authorized, rather than 403
        if not is_authorized then
            ngx.exit(ngx.HTTP_NOT_FOUND)
        end
    }
    
    # 3. Serve the file if the script didn't exit with 404
    default_type application/json;
}

}

